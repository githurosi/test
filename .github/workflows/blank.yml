åç§°ï¼šè‡ªåŠ¨æ›´æ–°å·¥ä½œç¨‹åº  # å·¥ä½œæµåç§°

å¼€ï¼š  # è§¦å‘æ¡ä»¶é…ç½®
  æ¨é€ï¼š  # æ¨é€äº‹ä»¶è§¦å‘
    åˆ†æ”¯ï¼š
      - ä¸»è¦  # ä»…ç›‘å¬mainåˆ†æ”¯çš„æ¨é€
  æ—¶é—´è¡¨ï¼š  # å®šæ—¶ä»»åŠ¡é…ç½®
    - cronï¼š â€œ0 1 * * *â€  # æ¯å¤©UTCæ—¶é—´1ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ï¼‰
  workflow_dispatchï¼š  # æ‰‹åŠ¨è§¦å‘é…ç½®
    è¾“å…¥ï¼š
      force_updateï¼š  # æ‰‹åŠ¨è§¦å‘æ—¶å¯æŒ‡å®šå‚æ•°
        descriptionï¼š 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'  # å‚æ•°è¯´æ˜
        ç±»å‹ï¼šå¸ƒå°”å€¼
        é»˜è®¤å€¼ï¼šFalse  # é»˜è®¤ä¸å¼ºåˆ¶æ›´æ–°

æƒé™ï¼š  # æƒé™é…ç½®
  å†…å®¹ï¼š å†™å…¥  # å…è®¸æ¨é€ä»£ç åˆ°ä»“åº“
  id-tokenï¼šå†™å…¥  # å…è®¸ä½¿ç”¨OIDCèº«ä»½éªŒè¯

å¹¶å‘ï¼š  # å¹¶å‘æ§åˆ¶
  ç»„ï¼š ${{ github.workflow }}-${{ github.ref }}  # æŒ‰å·¥ä½œæµ+åˆ†æ”¯åˆ†ç»„
  æ­£åœ¨å–æ¶ˆï¼štrue  # æ–°è¿è¡Œè‡ªåŠ¨å–æ¶ˆåŒç»„æ—§è¿è¡Œ

å·¥ä½œæœºä¼šï¼š  # ä½œä¸šå®šä¹‰
  æ›´æ–°ï¼š  # ä½œä¸šåç§°
    è¿è¡Œæ—¶é—´ï¼šubuntu-latest  # ä½¿ç”¨æœ€æ–°Ubuntuç¯å¢ƒ
    è¶…æ—¶åˆ†é’Ÿæ•°ï¼š5  # ä½œä¸šè¶…æ—¶æ—¶é—´
    è¾“å‡ºï¼š  # ä½œä¸šè¾“å‡º
      new_versionï¼š ${{ steps.update.outputs.new_version }}  # è¾“å‡ºæ–°ç‰ˆæœ¬å·
    æ­¥éª¤ï¼š  # ä½œä¸šæ­¥éª¤
      - åç§°ï¼š æ£€å‡ºä»“åº“  # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“
        ç”¨é€”ï¼šä½œ/checkout@v4  # ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œv4ç‰ˆæœ¬
        æ›¿æ¢ä¸ºï¼š  # è‡ªå®šä¹‰å‚æ•°
          è·å–æ·±åº¦ï¼š1  # ä»…è·å–æœ€æ–°æäº¤
          è·¯å¾„ï¼š worker-repo  # æ£€å‡ºåˆ°æŒ‡å®šç›®å½•

      - nameï¼š é¢„å®‰è£…ä¾èµ–  # æ­¥éª¤2ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
        è¿è¡Œï¼š |  # æ‰§è¡Œå¤šè¡Œå‘½ä»¤
sudo apt-get æ›´æ–°  # æ›´æ–°APTåŒ…åˆ—è¡¨
sudo apt-get install -y pigz jq translate-shell  # å®‰è£…å¹¶è¡Œgzipã€JSONå¤„ç†å™¨ã€ç¿»è¯‘å·¥å…·

      - nameï¼š æ£€æŸ¥å¹¶æ›´æ–° Worker  # æ­¥éª¤3ï¼šæ ¸å¿ƒæ›´æ–°é€»è¾‘
        IDï¼šæ›´æ–°  # æ­¥éª¤æ ‡è¯†ç¬¦
        ç¯å¢ƒï¼š  # ç¯å¢ƒå˜é‡
          GITHUB_TOKENï¼š${{ secretsã€‚GITHUB_TOKEN }}  # ä½¿ç”¨ä»“åº“çš„è®¿é—®ä»¤ç‰Œ
        è¿è¡Œï¼š |  # æ‰§è¡Œå¤šè¡Œshellè„šæœ¬
è®¾ç½® -euo pipefail  # è®¾ç½®ä¸¥æ ¼é”™è¯¯å¤„ç†æ¨¡å¼
start_time=$ï¼ˆæ—¥æœŸ +%sï¼‰  # è®°å½•å¼€å§‹æ—¶é—´æˆ³
          
æ—¥å¿—ï¼ˆï¼‰ {  # å®šä¹‰æ—¥å¿—å‡½æ•°
æœ¬åœ°çº§åˆ« = $1  # æ¥æ”¶æ—¥å¿—çº§åˆ«å‚æ•°
è½¬å˜  # åˆ‡æ¢åˆ°worker-repoç›®å½•
echo â€œ[$ï¼ˆdate +'%Y-%m-%d %Hï¼š%Mï¼š%S'ï¼‰] [$level] $@â€  # æ ¼å¼åŒ–è¾“å‡ºæ—¥å¿—
          }
          
# åˆå§‹åŒ–å˜é‡
FORCE_UPDATE=${{ inputs.force_update }}  # è·å–æ‰‹åŠ¨è§¦å‘å‚æ•°
LOCAL_VERSION=$ï¼ˆcat worker-repo/version.txt 2>/dev/null || echo â€œâ€ï¼‰  # è¯»å–æœ¬åœ°ç‰ˆæœ¬å·
log â€œINFOâ€ â€œå¼€å§‹æ£€æŸ¥æ›´æ–°...â€  # è®°å½•å¼€å§‹æ—¥å¿—
log â€œDEBUGâ€ â€œæœ¬åœ°ç‰ˆæœ¬ï¼š ${LOCAL_VERSIONï¼š-æ— }â€  # è°ƒè¯•æ—¥å¿—
          
# è·å–æœ€æ–°ç‰ˆæœ¬
REPO_URL=â€œhttps://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releasesâ€  # ä»“åº“APIåœ°å€
å“åº”=$ï¼ˆcurl -s --retry 3 \  # é™é»˜æ¨¡å¼curlï¼Œé‡è¯•3æ¬¡
-H â€œæˆæƒï¼štoken $GITHUB_TOKENâ€ \  # æºå¸¦è®¤è¯å¤´
-H â€œæ¥å—ï¼šapplication/vnd.github.v3+jsonâ€ \  # æŒ‡å®šAPIç‰ˆæœ¬
â€œ$REPO_URLâ€ï¼‰  # è¯·æ±‚æœ€æ–°å‘å¸ƒä¿¡æ¯
          
# è§£æç‰ˆæœ¬ä¿¡æ¯
TAG_NAME=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].tag_name'ï¼‰  # æå–æœ€æ–°æ ‡ç­¾å
DOWNLOAD_URL=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].assets[] |selectï¼ˆ.name == â€œworker.zipâ€ï¼‰ | .browser_download_url'ï¼‰  # æŸ¥æ‰¾æŒ‡å®šèµ„äº§ä¸‹è½½åœ°å€
RELEASE_NOTES=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].body'ï¼‰  # è·å–å‘å¸ƒè¯´æ˜
          
# ç‰ˆæœ¬æ¯”è¾ƒ
if [ â€œ$LOCAL_VERSIONâ€ = â€œ$TAG_NAMEâ€ ] & & [ â€œ$FORCE_UPDATEâ€ ï¼= â€œtrueâ€ ];ç„¶å  # ç‰ˆæœ¬ç›¸åŒä¸”éå¼ºåˆ¶æ›´æ–°æ—¶è·³è¿‡
log â€œINFOâ€ â€œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°â€  # è®°å½•æ— éœ€æ›´æ–°æ—¥å¿—
echo â€œnew_version=$LOCAL_VERSIONâ€ >> $GITHUB_OUTPUT  # è¾“å‡ºå½“å‰ç‰ˆæœ¬å·
å‡ºå£ 0  # æ­£å¸¸é€€å‡º
fi
          
# å‡†å¤‡æ›´æ–°å†…å®¹
log â€œINFOâ€ â€œæ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š $TAG_NAMEâ€  # è®°å½•å‘ç°æ–°ç‰ˆæœ¬
log â€œINFOâ€ â€œæ­£åœ¨ç¿»è¯‘æ›´æ–°æ—¥å¿—...â€  # è®°å½•ç¿»è¯‘å¼€å§‹
          
# ç¿»è¯‘æ›´æ–°æ—¥å¿—
TRANSLATED_NOTES=$ï¼ˆecho â€œ$RELEASE_NOTESâ€ | trans -b -e google -t zh-CNï¼‰  # ä½¿ç”¨è°·æ­Œå¼•æ“ç¿»è¯‘æˆä¸­æ–‡
          
# ç”ŸæˆMarkdownæ ¼å¼å†…å®¹
FORMATTED_NOTES=$ï¼ˆecho â€œ$TRANSLATED_NOTESâ€ | sed 's/^/ /'ï¼‰  # æ·»åŠ ç¼©è¿›æ ¼å¼
          
# æ›´æ–°æ–‡ä»¶
echo â€œ$TAG_NAMEâ€ > worker-repo/version.txt  # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
echo â€œ$TRANSLATED_NOTESâ€ > worker-repo/changelog.md  # ä¿å­˜ç¿»è¯‘åçš„æ›´æ–°æ—¥å¿—
          
# è‡ªåŠ¨è¿½åŠ åˆ°README
echo â€œæ­£åœ¨å°†æ›´æ–°æ—¥å¿—è¿½åŠ åˆ°README...â€  # è®°å½•æ“ä½œ
echo â€œâ€ >> worker-repo/README.md  # æ·»åŠ ç©ºè¡Œ
echo â€œ## æ›´æ–°æ—¥å¿— ğŸ“ â€ >> worker-repo/README.md  # æ·»åŠ æ ‡é¢˜
echo â€œ### $TAG_NAMEâ€ >> worker-repo/README.md  # æ·»åŠ ç‰ˆæœ¬æ ‡é¢˜
echo â€œ$FORMATTED_NOTESâ€ >> worker-repo/README.md  # æ·»åŠ æ ¼å¼åŒ–å†…å®¹
echo â€œ---â€ >> worker-repo/README.md  # æ·»åŠ åˆ†éš”çº¿
          
# æäº¤ä¿¡æ¯
log â€œINFOâ€ â€œæ›´æ–°å®Œæˆï¼Œæ–°ç‰ˆæœ¬ï¼š $TAG_NAMEâ€  # è®°å½•æ›´æ–°å®Œæˆ
echo â€œnew_version=$TAG_NAMEâ€ >> $GITHUB_OUTPUT  # è¾“å‡ºæ–°ç‰ˆæœ¬å·
          
# æ€§èƒ½ç»Ÿè®¡
total_time=$ï¼ˆï¼ˆ $ï¼ˆdate +%sï¼‰ - start_time ï¼‰ï¼‰  # è®¡ç®—æ€»è€—æ—¶
log â€œINFOâ€ â€œæ€»æ‰§è¡Œæ—¶é—´ï¼š ${total_time}ç§’â€  # è¾“å‡ºæ€§èƒ½ç»Ÿè®¡

      - nameï¼š æäº¤æ›´æ”¹  # æ­¥éª¤4ï¼šè‡ªåŠ¨æäº¤æ›´æ”¹
        å¦‚æœï¼š alwaysï¼ˆï¼‰  # æ— è®ºå‰åºæ­¥éª¤æˆåŠŸä¸å¦éƒ½æ‰§è¡Œ
        ç”¨é€”ï¼š stefanzweifel/git-auto-commit-action@v5  # ä½¿ç”¨è‡ªåŠ¨æäº¤åŠ¨ä½œv5ç‰ˆæœ¬
        æ›¿æ¢ä¸ºï¼š  # è‡ªå®šä¹‰å‚æ•°
          ä»“åº“ï¼š worker-repo  # æŒ‡å®šå·¥ä½œç›®å½•
          commit_messageï¼š |  # æäº¤ä¿¡æ¯æ¨¡æ¿
ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬ï¼š ${{ steps.update.outputs.new_version }}  # æäº¤æ ‡é¢˜
            
æ›´æ–°å†…å®¹ï¼š  # æäº¤æ­£æ–‡
$ï¼ˆcat worker-repo/changelog.md | head -n 5 | sed 's/^/ /'ï¼‰  # æ˜¾ç¤ºæ›´æ–°æ—¥å¿—å‰5è¡Œ
          åˆ†æ”¯ï¼šmain  # æŒ‡å®šç›®æ ‡åˆ†æ”¯
          file_patternï¼šâ€œversion.txt changelog.md README.md *.jsâ€  # ç›‘æ§æ–‡ä»¶æ¨¡å¼
