åç§°ï¼šè‡ªåŠ¨æ›´æ–°å·¥ä½œç¨‹åº

å¼€ï¼š
  æ¨é€ï¼š
    åˆ†æ”¯ï¼š
      - ä¸»è¦
  æ—¶é—´è¡¨ï¼š
    - cronï¼š â€œ0 1 * * *â€ # ğŸŒ‡ åŒ—äº¬æ—¶é—´9ç‚¹ï¼ˆUTC+8ï¼‰å¯¹åº”UTCæ—¶é—´1ç‚¹
  workflow_dispatchï¼š
    è¾“å…¥ï¼š
      force_updateï¼š
        descriptionï¼š 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        ç±»å‹ï¼šå¸ƒå°”å€¼
        é»˜è®¤å€¼ï¼šFalse

æƒé™ï¼š
  å†…å®¹ï¼š å†™å…¥
  id-tokenï¼šå†™å…¥

å¹¶å‘ï¼š
  ç»„ï¼š ${{ github.workflow }}-${{ github.ref }}
  æ­£åœ¨å–æ¶ˆï¼štrue

å·¥ä½œæœºä¼šï¼š
  æ›´æ–°ï¼š
    è¿è¡Œæ—¶é—´ï¼šubuntu-latest
    è¶…æ—¶åˆ†é’Ÿæ•°ï¼š5
    è¾“å‡ºï¼š
      new_versionï¼š ${{ steps.update.outputs.new_version }}
    æ­¥éª¤ï¼š
      - åç§°ï¼š æ£€å‡ºä»“åº“
        ç”¨é€”ï¼šä½œ/checkout@v4
        æ›¿æ¢ä¸ºï¼š
          è·å–æ·±åº¦ï¼š1
          è·¯å¾„ï¼š worker-repo

      - nameï¼š é¢„å®‰è£…ä¾èµ–
        è¿è¡Œï¼š |
sudo apt-get æ›´æ–°
sudo apt-get install -y pigz jq translate-shell
      - nameï¼š æ£€æŸ¥å¹¶æ›´æ–° Worker
        IDï¼šæ›´æ–°
        ç¯å¢ƒï¼š
          GITHUB_TOKENï¼š${{ secretsã€‚GITHUB_TOKEN }}
        è¿è¡Œï¼š |
è®¾ç½® -euo pipefail
start_time=$ï¼ˆæ—¥æœŸ +%sï¼‰
          
æ—¥å¿—ï¼ˆï¼‰ {
æœ¬åœ°çº§åˆ« = $1
è½¬å˜
echo â€œ[$ï¼ˆdate +'%Y-%m-%d %Hï¼š%Mï¼š%S'ï¼‰] [$level] $@â€
          }
          
# åˆå§‹åŒ–å˜é‡
FORCE_UPDATE=${{ inputs.force_update }}
LOCAL_VERSION=$ï¼ˆcat worker-repo/version.txt 2>/dev/null || echo â€œâ€ï¼‰
log â€œINFOâ€ â€œå¼€å§‹æ£€æŸ¥æ›´æ–°...â€
log â€œDEBUGâ€ â€œæœ¬åœ°ç‰ˆæœ¬ï¼š ${LOCAL_VERSIONï¼š-æ— }â€
          
# è·å–æœ€æ–°ç‰ˆæœ¬
REPO_URL=â€œhttps://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releasesâ€
å“åº”=$ï¼ˆcurl -s --retry 3 \
-H â€œæˆæƒï¼štoken $GITHUB_TOKENâ€ \
-H â€œæ¥å—ï¼šapplication/vnd.github.v3+jsonâ€ \
â€œ$REPO_URLâ€ï¼‰
          
# è§£æç‰ˆæœ¬ä¿¡æ¯
TAG_NAME=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].tag_name'ï¼‰
DOWNLOAD_URL=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].assets[] |selectï¼ˆ.name == â€œworker.zipâ€ï¼‰ | .browser_download_url'ï¼‰
RELEASE_NOTES=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.[0].body'ï¼‰
          
# ç‰ˆæœ¬æ¯”è¾ƒ
if [ â€œ$LOCAL_VERSIONâ€ = â€œ$TAG_NAMEâ€ ] & & [ â€œ$FORCE_UPDATEâ€ ï¼= â€œtrueâ€ ];ç„¶å
log â€œINFOâ€ â€œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°â€
echo â€œnew_version=$LOCAL_VERSIONâ€ >> $GITHUB_OUTPUT
å‡ºå£ 0
fi
          
# å‡†å¤‡æ›´æ–°å†…å®¹
log â€œINFOâ€ â€œæ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š $TAG_NAMEâ€
log â€œINFOâ€ â€œæ­£åœ¨ç¿»è¯‘æ›´æ–°æ—¥å¿—...â€
          
# ç¿»è¯‘æ›´æ–°æ—¥å¿—
TRANSLATED_NOTES=$ï¼ˆecho â€œ$RELEASE_NOTESâ€ | trans -b -e google -t zh-CNï¼‰
          
# ç”ŸæˆMarkdownæ ¼å¼å†…å®¹
FORMATTED_NOTES=$ï¼ˆecho â€œ$TRANSLATED_NOTESâ€ | sed 's/^/ /'ï¼‰
          
# æ›´æ–°æ–‡ä»¶
echo â€œ$TAG_NAMEâ€ > worker-repo/version.txt
echo â€œ$TRANSLATED_NOTESâ€ > worker-repo/changelog.md
          
# è‡ªåŠ¨è¿½åŠ åˆ°README
echo â€œæ­£åœ¨å°†æ›´æ–°æ—¥å¿—è¿½åŠ åˆ°README...â€
echo â€œâ€ >> worker-repo/README.md
echo â€œ## æ›´æ–°æ—¥å¿— ğŸ“ â€ >> worker-repo/README.md
echo â€œ### $TAG_NAMEâ€ >> worker-repo/README.md
echo â€œ$FORMATTED_NOTESâ€ >> worker-repo/README.md
echo â€œ---â€ >> worker-repo/README.md
          
# æäº¤ä¿¡æ¯
log â€œINFOâ€ â€œæ›´æ–°å®Œæˆï¼Œæ–°ç‰ˆæœ¬ï¼š $TAG_NAMEâ€
echo â€œnew_version=$TAG_NAMEâ€ >> $GITHUB_OUTPUT
          
# æ€§èƒ½ç»Ÿè®¡
total_time=$ï¼ˆï¼ˆ $ï¼ˆdate +%sï¼‰ - start_time ï¼‰ï¼‰
log â€œINFOâ€ â€œæ€»æ‰§è¡Œæ—¶é—´ï¼š ${total_time}ç§’â€
      - nameï¼š æäº¤æ›´æ”¹
        å¦‚æœï¼š alwaysï¼ˆï¼‰
        ç”¨é€”ï¼š stefanzweifel/git-auto-commit-action@v5
        æ›¿æ¢ä¸ºï¼š
          ä»“åº“ï¼š worker-repo
          commit_messageï¼š |
ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬ï¼š ${{ steps.update.outputs.new_version }}
            
æ›´æ–°å†…å®¹ï¼š
$ï¼ˆcat worker-repo/changelog.md | head -n 5 | sed 's/^/ /'ï¼‰
          åˆ†æ”¯ï¼šmain
          file_patternï¼šâ€œversion.txt changelog.md README.md *.jsâ€
