name: Worker ä»£ç æ··æ·†ä¸æäº¤

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ¨¡å¼'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©åˆå¤œè¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: main-repo
          
      - name: å‡†å¤‡ Worker ä»“åº“
        run: |
          git clone https://github.com/${{ github.repository_owner }}/worker-repo.git
          cd worker-repo
          git checkout main

      - name: ç¼“å­˜ npm ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('worker-repo/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: å®‰è£…æ··æ·†å·¥å…·
        run: |
          echo "å®‰è£… JavaScript æ··æ·†å·¥å…·..."
          npm install -g javascript-obfuscator@latest
          # éªŒè¯å®‰è£…
          javascript-obfuscator --version

      - name: æ··æ·† Worker ä»£ç ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
        id: obfuscate
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.force_update == 'true') || github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          cd worker-repo
          
          echo "å¼€å§‹æ··æ·† Worker ä»£ç ..."
          start_time=$(date +%s)
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          mkdir -p tmp
          cp _worker.js tmp/
          
          # æ‰§è¡Œæ··æ·†ï¼ˆæ·»åŠ è¶…æ—¶å¤„ç†ï¼‰
          timeout 10m javascript-obfuscator tmp/_worker.js \
            --output _worker.obfuscated.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.75 \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.5 \
            --identifier-names-generator mangled \
            --string-array true \
            --string-array-encoding 'rc4' \
            --string-array-threshold 0.75 \
            --transform-object-keys true \
            --self-defending true \
            --domain-lock 'your-domain.com' || {
              echo "âŒ æ··æ·†è¿‡ç¨‹è¶…æ—¶æˆ–å¤±è´¥"
              exit 1
            }
          
          # æ›¿æ¢åŸæ–‡ä»¶
          mv _worker.obfuscated.js _worker.js
          rm -rf tmp
          
          end_time=$(date +%s)
          echo "æ··æ·†å®Œæˆï¼Œè€—æ—¶: $((end_time - start_time)) ç§’"

      - name: å‡†å¤‡æäº¤ä¿¡æ¯
        id: prepare-commit
        if: ${{ success() && steps.obfuscate.outcome == 'success' }}
        run: |
          cd worker-repo
          # ç”Ÿæˆå˜æ›´æ—¥å¿—æ‘˜è¦ï¼ˆç¤ºä¾‹ä¸­å–å‰5è¡Œï¼‰
          CHANGELOG_SUMMARY=$(head -n 5 changelog.md | sed 's/^/    /')
          # ç”Ÿæˆæäº¤æ¶ˆæ¯
          COMMIT_MESSAGE="ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬: $(date +%Y-%m-%d)
          
          æ›´æ–°å†…å®¹ï¼š
          $CHANGELOG_SUMMARY
          
          ${{ github.event.inputs.force_update == 'true' && 'ğŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼' || '' }}"
          
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æäº¤æ›´æ”¹ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
        if: ${{ success() && steps.obfuscate.outcome == 'success' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: worker-repo
          commit_message: ${{ steps.prepare-commit.outputs.commit_message }}
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: main
          push_options: "--force-with-lease"
          file_pattern: "version.txt changelog.md README.md *.js"
          create_branch: false

      - name: å®Œæˆé€šçŸ¥
        if: ${{ always() }}
        run: |
          echo "â³ å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
            exit 1
          fi
