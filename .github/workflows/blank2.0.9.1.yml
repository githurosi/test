nameï¼š Test workflow # æµ‹è¯•å·¥ä½œæµ

å¼€ï¼š
  æ¨é€ï¼š
    åˆ†æ”¯ï¼š
      - ä¸»è¦
  æ—¶é—´è¡¨ï¼š
    - cronï¼š â€œ0 1 * * *â€
  workflow_dispatchï¼š
    è¾“å…¥ï¼š
      force_syncï¼š
        descriptionï¼š 'å¼ºåˆ¶ç«‹å³åŒæ­¥'
        ç±»å‹ï¼šå¸ƒå°”å€¼
        é»˜è®¤å€¼ï¼šFalse

æƒé™ï¼š
  å†…å®¹ï¼š å†™å…¥
  id-tokenï¼šå†™å…¥

å¹¶å‘ï¼š
  ç»„ï¼š ${{ github.workflow }}-${{ github.ref }}
  æ­£åœ¨å–æ¶ˆï¼štrue

å·¥ä½œæœºä¼šï¼š
  sync-and-obfuscate ä¸­ï¼š
    è¿è¡Œæ—¶é—´ï¼šubuntu-latest
    è¶…æ—¶åˆ†é’Ÿæ•°ï¼š10
    æ­¥éª¤ï¼š
      #1. åŸºç¡€ç¯å¢ƒå‡†å¤‡
      - åç§°ï¼š æ£€å‡ºä»“åº“
        ç”¨é€”ï¼šä½œ/checkout@v4
        æ›¿æ¢ä¸ºï¼š
          å‚è€ƒï¼š main
          è·å–æ·±åº¦ï¼š 0

      - åç§°ï¼š é¢„å®‰è£…ä¾èµ–ï¼ˆç²¾ç®€ç‰ˆï¼‰
        è¿è¡Œï¼š |
# ä»…ä¿ç•™å¿…è¦ä¾èµ–
sudo apt-get update -qq
sudo apt-get install -y -qq jq
      #2. ç‰ˆæœ¬æ£€æµ‹å¼•æ“ï¼ˆæ¥è‡ªä»£ç 2ï¼‰
      - nameï¼š æ£€æŸ¥Workerç‰ˆæœ¬
        ç¼–å·ï¼š version_check
        ç¯å¢ƒï¼š
          GITHUB_TOKENï¼š${{ secretsã€‚GITHUB_TOKEN }}
        è¿è¡Œï¼š |
è®¾ç½® -euo pipefail
start_time=$ï¼ˆæ—¥æœŸ +%sï¼‰
          
æ—¥å¿—ï¼ˆï¼‰ {
æœ¬åœ°çº§åˆ« = $1
è½¬å˜
echo â€œ[$ï¼ˆdate +'%Y-%m-%d %Hï¼š%Mï¼š%S'ï¼‰] [$level] $@â€
          }
          
# åˆå§‹åŒ–å˜é‡
FORCE_UPDATE=${{ inputs.force_sync }}
LOCAL_VERSION=$ï¼ˆcat version.txt 2>/dev/null || echo â€œ0.0.0â€ï¼‰
log â€œINFOâ€ â€œå¼€å§‹ç‰ˆæœ¬æ£€æµ‹...â€
log â€œDEBUGâ€ â€œæœ¬åœ°ç‰ˆæœ¬ï¼š ${LOCAL_VERSION}â€
          
# è·å–æœ€æ–°ç‰ˆæœ¬
REPO_URL=â€œhttps://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latestâ€
å“åº”=$ï¼ˆcurl -s --retry 3 \
-H â€œæˆæƒï¼štoken $GITHUB_TOKENâ€ \
-H â€œæ¥å—ï¼šapplication/vnd.github.v3+jsonâ€ \
â€œ$REPO_URLâ€ï¼‰
          
# è§£æç‰ˆæœ¬ä¿¡æ¯
TAG_NAME=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.tag_name'ï¼‰
RELEASE_NOTES=$ï¼ˆecho â€œ$RESPONSEâ€ | jq -r '.body'ï¼‰
          
# ç‰ˆæœ¬æ¯”è¾ƒ
if [ â€œ$LOCAL_VERSIONâ€ = â€œ$TAG_NAMEâ€ ] & & [ â€œ$FORCE_UPDATEâ€ ï¼= â€œtrueâ€ ];ç„¶å
log â€œINFOâ€ â€œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°â€
echo â€œnew_version=$LOCAL_VERSIONâ€ >> $GITHUB_OUTPUT
å‡ºå£ 0
fi
          
# å‡†å¤‡æ›´æ–°å…ƒæ•°æ®
log â€œINFOâ€ â€œæ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š $TAG_NAMEâ€
echo â€œ$TAG_NAMEâ€ > version.txt
echo â€œ$RELEASE_NOTESâ€ > changelog.md
echo â€œnew_version=$TAG_NAMEâ€ >> $GITHUB_OUTPUT
          
# æ€§èƒ½ç»Ÿè®¡
total_time=$ï¼ˆï¼ˆ $ï¼ˆdate +%sï¼‰ - start_time ï¼‰ï¼‰
log â€œINFOâ€ â€œç‰ˆæœ¬æ£€æµ‹è€—æ—¶ï¼š ${total_time}ç§’â€
      #3. æ¡ä»¶è§¦å‘æ··æ·†æµç¨‹ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶æ‰§è¡Œï¼‰
      - nameï¼š æ‰§è¡Œæ··æ·†æ›´æ–°
        å¦‚æœï¼š steps.version_check.outputs.new_version ï¼= '0.0.0'
        è¿è¡Œï¼š |
# å®‰è£…æ··æ·†å·¥å…·ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
npm install -g javascript-obfuscator@4.0.0
          
# æ¨¡æ‹ŸWorkeræ–‡ä»¶ï¼ˆå®é™…åº”ä»å¤–éƒ¨æºè·å–ï¼‰
echo 'console.logï¼ˆâ€œWorkeræ–‡ä»¶å†…å®¹â€ï¼‰;' > _worker.js
          
# æ‰§è¡Œæ··æ·†ï¼ˆä¿æŒåŸæœ‰é…ç½®ï¼‰
javascript-obfuscator _worker.js \
--è¾“å‡º _worker.obfuscated.js \
--compact çœŸ \
--control-flow-flattening true \
--control-flow-flattening-threshold 0.75 \
--dead-code-injection true \
--dead-code-injection-threshold 0.5 \
--identifier-names-generator è¢«ç ´å \
--string-array çœŸ \
--string-array-encoding 'rc4' \
--string-array-threshold 0.75 \
--transform-object-keys true \
--è‡ªå« çœŸ \
--domain-lock 'your-domain.com'
          
ä¸­_worker.obfuscated.js _worker.js
      #4. ç»Ÿä¸€æäº¤å˜æ›´
      - nameï¼š æäº¤æ‰€æœ‰å˜æ›´
        ç”¨é€”ï¼š stefanzweifel/git-auto-commit-action@v5
        æ›¿æ¢ä¸ºï¼š
          commit_messageï¼š |
ğŸ”„ æ™ºèƒ½åŒæ­¥æ›´æ–° [è·³è¿‡ CI]
            
ç‰ˆæœ¬ï¼š ${{ steps.version_check.outputs.new_version }}
æ›´æ–°å†…å®¹ï¼š
$ï¼ˆcat changelog.md | head -n 5 | sed 's/^/ /'ï¼‰
          commit_authorï¼šâ€œgithub-actions[bot] <github-actions[bot]@users.noreply.github.com>â€
          åˆ†æ”¯ï¼šmain
          push_optionsï¼šâ€œ--force-with-leaseâ€
          file_patternï¼šâ€œversion.txt changelog.md *.jsâ€
          skip_fetchï¼štrue
